CKFinder.addPlugin("imageresize",{connectorInitialized:function(b,a){var c=a.selectSingleNode("Connector/PluginsInfo/imageresize/@smallThumb");if(c){CKFinder.config.imageresize_thumbSmall=c.value;}c=a.selectSingleNode("Connector/PluginsInfo/imageresize/@mediumThumb");if(c){CKFinder.config.imageresize_thumbMedium=c.value;}c=a.selectSingleNode("Connector/PluginsInfo/imageresize/@largeThumb");if(c){CKFinder.config.imageresize_thumbLarge=c.value;}},uiReady:function(c){var l=/^(.*)\.([^\.]+)$/,b=/^(.*?)(?:_\d+x\d+)?\.([^\.]+)$/,j=/^\s*(\d+)(px)?\s*$/i,d=/(^\s*(\d+)(px)?\s*$)|^$/i,k={width:0,height:0},a,i;var f=function(n){var o=n.getValueOf("tab1","width")||0,m=n.getValueOf("tab1","height")||0,q=n.getContentElement("tab1","createNewBox");if(o&&m){var p=a.name.match(b);n.setValueOf("tab1","fileName",p[1]+"_"+o+"x"+m+"."+p[2]);q.getElement().show();}else{q.getElement().hide();}};var h=function(){var r=this.getValue(),q=this.getDialog(),s=c.config.imagesMaxWidth,t=c.config.imagesMaxHeight,m=r.match(j),o=k.width,u=k.height,n,p;if(m){r=m[1];}if(!c.config.imageresize_allowEnlarging){if(o&&o<s){s=o;}if(u&&u<t){t=u;}}if(t>0&&this.id=="height"&&r>t){r=t;q.setValueOf("tab1","height",r);}if(s>0&&this.id=="width"&&r>s){r=s;q.setValueOf("tab1","width",r);}if(q.lockRatio&&o&&u){if(this.id=="height"){if(r&&r!="0"){r=Math.round(o*(r/u));}if(!isNaN(r)){if(s>0&&r>s){r=s;n=Math.round(u*(r/o));q.setValueOf("tab1","height",n);}q.setValueOf("tab1","width",r);}}else{if(r&&r!="0"){r=Math.round(u*(r/o));}if(!isNaN(r)){if(t>0&&r>t){r=t;p=Math.round(o*(r/u));q.setValueOf("tab1","width",p);}q.setValueOf("tab1","height",r);}}}f(q);};var e=function(m){if(k.width&&k.height){m.setValueOf("tab1","width",k.width);m.setValueOf("tab1","height",k.height);f(m);}};var g=function(n,q){var r=n.getElement().getDocument(),p=r.getById("btnLockSizes");if(k.width&&k.height){if(q=="check"){var o=n.getValueOf("tab1","width"),m=n.getValueOf("tab1","height"),t=k.width*1000/k.height,s=o*1000/m;n.lockRatio=false;if(!o&&!m){n.lockRatio=true;}else{if(!isNaN(t)&&!isNaN(s)){if(Math.round(t)==Math.round(s)){n.lockRatio=true;}}}}else{if(q!=undefined){n.lockRatio=q;}else{n.lockRatio=!n.lockRatio;}}}else{if(q!="check"){n.lockRatio=false;}}if(n.lockRatio){p.removeClass("ckf_btn_unlocked");}else{p.addClass("ckf_btn_unlocked");}return n.lockRatio;};CKFinder.dialog.add("resizeDialog",function(m){return{title:m.lang.Imageresize.dialogTitle.replace("%s",m.getSelectedFile().name),minWidth:390,minHeight:230,onShow:function(){var p=this,s=CKFinder.config.imageresize_thumbSmall,t=CKFinder.config.imageresize_thumbMedium,r=CKFinder.config.imageresize_thumbLarge;i=p.getElement().getDocument();a=m.getSelectedFile();this.setTitle(m.lang.Imageresize.dialogTitle.replace("%s",a.name));var o=i.getById("previewImage");var q=i.getById("imageSize");o.setAttribute("src",a.getThumbnailUrl(true));var n=function(v,u){if(!v||!u){q.setText("");return;}k.width=v;k.height=u;q.setText(v+" x "+u+" px");CKFinder.tools.setTimeout(function(){g(p,"check");},0,p);};m.connector.sendCommand("ImageResizeInfo",{fileName:a.name},function(w){if(w.checkError()){return;}var y=w.selectSingleNode("Connector/ImageInfo/@width"),v=w.selectSingleNode("Connector/ImageInfo/@height"),u;if(y&&v){y=parseInt(y.value,10);v=parseInt(v.value,10);n(y,v);var x=function(C,A){if(!A){return;}var z=/^(\d+)x(\d+)$/;u=z.exec(A);var B=p.getContentElement("tab1",C);if(0+u[1]>y&&0+u[2]>v){B.disable();B.getElement().setAttribute("title",m.lang.Imageresize.imageSmall).addClass("cke_disabled");}else{B.enable();B.getElement().setAttribute("title","").removeClass("cke_disabled");}};x("smallThumb",s);x("mediumThumb",t);x("largeThumb",r);}},a.folder.type,a.folder);if(!s){p.getContentElement("tab1","smallThumb").getElement().hide();}if(!t){p.getContentElement("tab1","mediumThumb").getElement().hide();}if(!r){p.getContentElement("tab1","largeThumb").getElement().hide();}if(!s&&!t&&!r){p.getContentElement("tab1","thumbsLabel").getElement().hide();}p.setValueOf("tab1","fileName",a.name);p.getContentElement("tab1","width").focus();p.getContentElement("tab1","fileName").setValue("");p.getContentElement("tab1","createNewBox").getElement().hide();n(0,0);},onOk:function(){var r=this,n=r.getValueOf("tab1","width"),u=r.getValueOf("tab1","height"),q=r.getValueOf("tab1","smallThumb"),v=r.getValueOf("tab1","mediumThumb"),t=r.getValueOf("tab1","largeThumb"),p=r.getValueOf("tab1","fileName"),o=r.getValueOf("tab1","createNew");if(n&&!u){m.openMsgDialog("",m.lang.Imageresize.invalidHeight);return false;}else{if(!n&&u){m.openMsgDialog("",m.lang.Imageresize.invalidWidth);return false;}}if(!m.config.imageresize_allowEnlarging&&(parseInt(n,10)>k.width||parseInt(u,10)>k.height)){var s=m.lang.Imageresize.sizeTooBig;m.openMsgDialog("",s.replace("%size",k.width+"x"+k.height));return false;}if((n&&u)||q||v||t){if(!o){p=a.name;}m.connector.sendCommandPost("ImageResize",null,{width:n,height:u,fileName:a.name,newFileName:p,overwrite:o?0:1,small:q?1:0,medium:v?1:0,large:t?1:0},function(w){if(w.checkError()){return;}m.openMsgDialog("",m.lang.Imageresize.resizeSuccess);m.refreshOpenedFolder();},a.folder.type,a.folder);}return undefined;},contents:[{id:"tab1",label:"",title:"",expand:true,padding:0,elements:[{type:"hbox",widths:["180px","280px"],children:[{type:"vbox",children:[{type:"html",html:""+'<style type="text/css">'+"a.ckf_btn_reset"+"{"+"float: right;"+"background-position: 0 -32px;"+'background-image: url("'+CKFinder.getPluginPath("imageresize")+'images/mini.gif");'+"width: 16px;"+"height: 16px;"+"background-repeat: no-repeat;"+"border: 1px none;"+"font-size: 1px;"+"}"+"a.ckf_btn_locked,"+"a.ckf_btn_unlocked"+"{"+"float: left;"+"background-position: 0 0;"+'background-image: url("'+CKFinder.getPluginPath("imageresize")+'images/mini.gif");'+"width: 16px;"+"height: 16px;"+"background-repeat: no-repeat;"+"border: none 1px;"+"font-size: 1px;"+"}"+"a.ckf_btn_unlocked"+"{"+"background-position: 0 -16px;"+'background-image: url("'+CKFinder.getPluginPath("imageresize")+'/images/mini.gif");'+"}"+".ckf_btn_over"+"{"+"border: outset 1px;"+"cursor: pointer;"+"cursor: hand;"+"}"+"</style>"+'<div style="height:100px;padding:7px">'+'<img id="previewImage" src="" style="margin-bottom:4px;" /><br />'+'<span style="font-size:9px;" id="imageSize"></span>'+"</div>"},{type:"html",id:"thumbsLabel",html:"<strong>"+m.lang.Imageresize.thumbnailNew+"</strong>"},{type:"checkbox",id:"smallThumb",checked:false,label:m.lang.Imageresize.thumbnailSmall.replace("%s",CKFinder.config.imageresize_thumbSmall)},{type:"checkbox",id:"mediumThumb",checked:false,label:m.lang.Imageresize.thumbnailMedium.replace("%s",CKFinder.config.imageresize_thumbMedium)},{type:"checkbox",id:"largeThumb",checked:false,label:m.lang.Imageresize.thumbnailLarge.replace("%s",CKFinder.config.imageresize_thumbLarge)}]},{type:"vbox",children:[{type:"html",html:"<strong>"+m.lang.Imageresize.newSize+"</strong>"},{type:"hbox",widths:["80%","20%"],children:[{type:"vbox",children:[{type:"text",labelLayout:"horizontal",label:m.lang.Imageresize.width,onKeyUp:h,validate:function(){var o=this.getValue();if(o){var n=o.match(j);if(!n||parseInt(n[1],10)<1){m.openMsgDialog("",m.lang.Imageresize.invalidWidth);return false;}}return true;},id:"width"},{type:"text",labelLayout:"horizontal",label:m.lang.Imageresize.height,onKeyUp:h,validate:function(){var o=this.getValue();if(o){var n=o.match(j);if(!n||parseInt(n[1],10)<1){m.openMsgDialog("",m.lang.Imageresize.invalidHeight);return false;}}return true;},id:"height"}]},{type:"html",onLoad:function(){var q=this.getElement().getDocument(),o=this.getDialog();var n=q.getById("btnResetSize"),p=q.getById("btnLockSizes");if(n){n.on("click",function(r){e(this);r.data.preventDefault();},o);n.on("mouseover",function(){this.addClass("ckf_btn_over");},n);n.on("mouseout",function(){this.removeClass("ckf_btn_over");},n);}if(p){p.on("click",function(s){var t=g(this),u=this.getValueOf("tab1","width");if(k.width&&u){var r=k.height/k.width*u;if(!isNaN(r)){this.setValueOf("tab1","height",Math.round(r));f(o);}}s.data.preventDefault();},o);p.on("mouseover",function(){this.addClass("ckf_btn_over");},p);p.on("mouseout",function(){this.removeClass("ckf_btn_over");},p);}},html:'<div style="margin-top:4px">'+'<a href="javascript:void(0)" tabindex="-1" title="'+m.lang.Imageresize.lockRatio+'" class="ckf_btn_locked ckf_btn_unlocked" id="btnLockSizes"></a>'+'<a href="javascript:void(0)" tabindex="-1" title="'+m.lang.Imageresize.resetSize+'" class="ckf_btn_reset" id="btnResetSize"></a>'+"</div>"}]},{type:"vbox",id:"createNewBox",hidden:true,children:[{type:"checkbox",checked:true,id:"createNew",label:m.lang.Imageresize.newImage,"default":true,onChange:function(){var n=this.getDialog();var o=n.getContentElement("tab1","fileName");if(o){if(!this.getValue()){o.getElement().hide();}else{o.getElement().show();}}}},{type:"text",label:"",validate:function(){var o=this.getDialog(),n=o.getContentElement("tab1","createNew"),q=this.getValue(),p=q.match(l);if(n&&o.getValueOf("tab1","width")&&o.getValueOf("tab1","height")){if(!q||!p){m.openMsgDialog("",m.lang.Imageresize.invalidName);return false;}if(a.ext!=p[2]){m.openMsgDialog("",m.lang.Imageresize.noExtensionChange);return false;}}return true;},id:"fileName"}]}]}]}]}],buttons:[CKFinder.dialog.okButton,CKFinder.dialog.cancelButton]};});c.addFileContextMenuOption({label:c.lang.Imageresize.contextMenuName,command:"resizeImage"},function(n,m){n.openDialog("resizeDialog");},function(m){if(!m.isImage()||!c.getSelectedFolder().type){return false;}if(m.folder.acl.fileDelete&&m.folder.acl.fileUpload){return true;}else{return -1;}});}});