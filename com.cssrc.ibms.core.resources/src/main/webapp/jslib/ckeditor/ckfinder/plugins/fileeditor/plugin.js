CKFinder.addPlugin("fileeditor",function(h){var l=/^(.*)\.([^\.]+)$/,b=/^(txt|css|html|htm|js|asp|cfm|cfc|ascx|php|inc|xml|xslt|xsl)$/i,g=/^(css|html|htm|js|xml|xsl|php)$/i,d,e,f=false,j;var i=CKFinder.getPluginPath("fileeditor")+"codemirror/";var c={css:"parsecss.js",js:["tokenizejavascript.js","parsejavascript.js"],xml:"parsexml.js",php:["parsexml.js","parsecss.js","tokenizejavascript.js","parsejavascript.js","../contrib/php/js/tokenizephp.js","../contrib/php/js/parsephp.js","../contrib/php/js/parsephphtmlmixed.js"]};var k={css:i+"css/csscolors.css",js:i+"css/jscolors.css",xml:i+"css/xmlcolors.css",php:[i+"css/xmlcolors.css",i+"css/jscolors.css",i+"css/csscolors.css",i+"contrib/php/css/phpcolors.css"]};k.xsl=k.xml;k.htm=k.xml;k.html=k.xml;c.xsl=c.xml;c.htm=c.xml;c.html=c.xml;var a=function(m){return b.test(m.ext);};CKFinder.dialog.add("fileEditor",function(o){var m,n;var p=(function(){return{id:"save",label:o.lang.Fileeditor.save,type:"button",onClick:function(r){if(!f){return true;}var s=r.data.dialog;var t=d?d.getCode():j.getById("fileContent").getValue();o.connector.sendCommandPost("SaveFile",null,{content:t,fileName:e.name},function(u){if(u.checkError()){return false;}o.openMsgDialog("",o.lang.Fileeditor.fileSaveSuccess);s.hide();return undefined;},e.folder.type,e.folder);return false;}};})();if(o.inPopup){n=o.document.documentElement.offsetWidth;m=o.document.documentElement.offsetHeight;}else{var q=(o.document.parentWindow||o.document.defaultView).parent;n=q.innerWidth?q.innerWidth:q.document.documentElement.clientWidth;m=q.innerHeight?q.innerHeight:q.document.documentElement.clientHeight;}return{title:o.getSelectedFile().name,minWidth:parseInt(n,10)*0.6,minHeight:parseInt(m,10)*0.7,onHide:function(){if(f){var r=j.getById("fileContent");if(r){r.remove();}}},onShow:function(){var v=this;var y=parseInt(n,10)*0.6-10;var t=parseInt(m,10)*0.7-20;j=v.getElement().getDocument();var x=j.getWindow();j.getById("fileArea").setHtml('<div class="ckfinder_loader_32" style="margin: 100px auto 0 auto;text-align:center;"><p style="height:'+t+"px;width:"+y+'px;">'+o.lang.Fileeditor.loadingFile+"</p></div>");e=o.getSelectedFile();var w=g.test(e.ext);this.setTitle(e.name);if(w&&x.$.CodeMirror===undefined){var u=j.$.getElementsByTagName("head")[0];var r=j.$.createElement("script");r.type="text/javascript";r.src=CKFinder.getPluginPath("fileeditor")+"codemirror/js/codemirror.js";u.appendChild(r);}var s=o.connector.composeUrl("DownloadFile",{FileName:e.name,format:"text",t:new Date().getTime()},e.folder.type,e.folder);CKFinder.ajax.load(s,function(C){if(C===null||(e.size>0&&C==="")){o.openMsgDialog("",o.lang.Fileeditor.fileOpenError);v.hide();return;}else{f=true;}var z=j.getById("fileArea");z.setStyle("height","100%");z.setHtml('<textarea id="fileContent" style="height:'+t+"px; width:"+y+'px"></textarea>');j.getById("fileContent").setText(C);d=null;if(w&&x.$.CodeMirror!==undefined){d=x.$.CodeMirror.fromTextArea(j.getById("fileContent").$,{height:t+"px",parserfile:c[e.ext.toLowerCase()],stylesheet:k[e.ext.toLowerCase()],path:i+"js/"});var B=j.createElement("button",{attributes:{"label":o.lang.common.undo}});B.on("click",function(){d.undo();});B.setHtml(o.lang.common.undo);B.appendTo(j.getById("fileArea"));var A=j.createElement("button",{attributes:{"label":o.lang.common.redo}});A.on("click",function(){d.redo();});A.setHtml(o.lang.common.redo);A.appendTo(j.getById("fileArea"));}});},contents:[{id:"tab1",label:"",title:"",expand:true,padding:0,elements:[{type:"html",id:"htmlLoader",html:""+'<style type="text/css">'+".CodeMirror-wrapping {background:white;}"+"</style>"+'<div id="fileArea"></div>'}]}],buttons:[p,CKFinder.dialog.cancelButton]};});h.addFileContextMenuOption({label:h.lang.Fileeditor.contextMenuName,command:"fileEditor"},function(n,m){n.openDialog("fileEditor");},function(m){var n=1024;if(typeof(CKFinder.config.fileeditorMaxSize)!="undefined"){n=CKFinder.config.fileeditorMaxSize;}if(a(m)&&m.size<=n){if(m.folder.acl.fileDelete){return true;}else{return -1;}}return false;});});